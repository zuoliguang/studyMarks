### 一、概述
    我们在考虑MySQL数据库的高可用架构时，主要考虑如下几方面：

    1、如果数据库发生了宕机或者意外中断等故障，能尽快恢复数据库的可用性，尽可能的减少停机时间，保证业务不会因为数据库的故障而中断。

    2、用作备份、只读副本等功能的非主节点的数据应该和主节点的数据实时或者最终保持一致。

    3、当业务发生数据库切换时，切换前后的数据库内容应当一致，不会因为数据缺失或者数据不一致而影响业务。

    关于对高可用的分级我们暂不做详细的讨论，这里只讨论常用高可用方案的优缺点以及选型。

### 二、高可用方案
#### 1、主从或主主半同步复制
    使用双节点数据库，搭建单向或者双向的半同步复制。
    
    在5.7以后的版本中，由于lossless replication、logical多线程复制等一些列新特性的引入，使得MySQL原生半同步复制更加可靠。
    
    常见架构如下：
    
![](https://github.com/zuoliguang/studyMarks/blob/master/images/1.jpg?raw=true)

    通常会和Proxy、Keepalived等第三方软件同时使用，即可以用来监控数据库的健康，又可以执行一系列管理命令。
    
    如果主库发生故障，切换到备库后仍然可以继续使用数据库。
    
    优点：

    架构比较简单，使用原生半同步复制作为数据同步的依据

    双节点，没有主机宕机后的选主问题，直接切换即可

    双节点，需求资源少，部署简单

    缺点：

    完全依赖于半同步复制，如果半同步复制退化为异步复制，数据一致性无法得到保证

    需要额外考虑HAProxy、Keepalived的高可用机制


#### 2、半同步复制优化

    半同步复制机制是可靠的。如果半同步复制一直是生效的，那么可以认为数据是一致的。但是由于网络波动等一些客观原因，导致半同步复制发生超时而切换为异步复制，这时便不能保证数据的一致性。所以尽可能的保证半同步复制，就可以提高数据的一致性。

    该方案同样使用双节点架构，但是在原有半同复制的基础上做了功能上的优化，使半同步复制的机制变得更加可靠。

    可参考的优化方案如下：

    双通道复制
    
![](https://github.com/zuoliguang/studyMarks/blob/master/images/2.jpg?raw=true)

    半同步复制由于发生超时后，复制断开，当再次建立起复制时，同时建立两条通道，其中一条半同步复制通道从当前位置开始复制，保证从机知道当前主机执行的进度。另外一条异步复制通道开始追补从机落后的数据。当异步复制通道追赶到半同步复制的起始位置时，恢复半同步复制。
    
    binlog文件服务器
    
![](https://github.com/zuoliguang/studyMarks/blob/master/images/3.jpg?raw=true)

    搭建两条半同步复制通道，其中连接文件服务器的半同步通道正常情况下不启用，当主从的半同步复制发生网络问题退化后，启动与文件服务器的半同步复制通道。当主从半同步复制恢复后，关闭与文件服务器的半同步复制通道。
    
    优点：

    双节点，需求资源少，部署简单

    架构简单，没有选主的问题，直接切换即可

    相比于原生复制，优化后的半同步复制更能保证数据的一致性

    缺点：

    需要修改内核源码或者使用MySQL通信协议。需要对源码有一定的了解，并能做一定程度的二次开发

    依旧依赖于半同步复制，没有从根本上解决数据一致性问题
    
#### 3、高可用架构优化
    
    将双节点数据库扩展到多节点数据库，或者多节点数据库集群。可以根据自己的需要选择一主两从、一主多从或者多主多从的集群。

    由于半同步复制，存在接收到一个从机的成功应答即认为半同步复制成功的特性，所以多从半同步复制的可靠性要优于单从半同步复制的可靠性。并且多节点同时宕机的几率也要小于单节点宕机的几率，所以多节点架构在一定程度上可以认为高可用性是好于双节点架构。

    但由于数据库数量较多，所以需要数据库管理软件来保证数据库的可维护性。可以选择MMM、MHA或者各个版本的Proxy等等。常见方案如下：

    MHA+多节点集群
    
![](https://github.com/zuoliguang/studyMarks/blob/master/images/4.jpg?raw=true)

    MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master，整个故障转移过程对应用程序完全透明。

    MHA Node运行在每台MySQL服务器上，主要作用是切换时处理二进制日志，确保切换尽量少丢数据。

    MHA也可以扩展到如下的多节点集群：
    
![](https://github.com/zuoliguang/studyMarks/blob/master/images/5.jpg?raw=true)
    
    优点：

    可以进行故障的自动检测和转移

    可扩展性较好，可以根据需要扩展MySQL的节点数量和结构

    相比于双节点的MySQL复制，三节点/多节点的MySQL发生不可用的概率更低

    缺点：

    至少需要三节点，相对于双节点需要更多的资源

    逻辑较为复杂，发生故障后排查问题，定位问题更加困难

    数据一致性仍然靠原生半同步复制保证，仍然存在数据不一致的风险

    可能因为网络分区发生脑裂现象。

    在此我向大家推荐一个架构学习交流群。交流学习群号：575745314 里面会分享一些资深架构师录制的视频录像：有Spring，MyBatis，Netty源码分析，高并发、高性能、分布式、微服务架构的原理，JVM性能优化、分布式架构等这些成为架构师必备的知识体系。还能领取免费的学习资源，目前受益良多

    ZooKeeper+Proxy

    ZooKeeper使用分布式算法保证集群数据的一致性，使用ZooKeeper可以有效的保证Proxy的高可用性，可以较好地避免网络分区现象的产生。

![](https://github.com/zuoliguang/studyMarks/blob/master/images/6.jpg?raw=true)

    优点：

    较好的保证了整个系统的高可用性，包括Proxy、MySQL

    扩展性较好，可以扩展为大规模集群

    缺点：

    数据一致性仍然依赖于原生的mysql半同步复制

    引入ZK，整个系统的逻辑变得更加复杂
    
    
#### 4、共享存储
#### 5、分布式协议
